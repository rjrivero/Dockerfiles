FROM gliderlabs/alpine:latest

MAINTAINER rjrivero

# For confd configuration templates
VOLUME /etc/confd

# For certificate, key and pem files
# Do not export. Otherwise, the dir is loopmounted by root and
# entrypoint.sh cannot create key and cert file.
# VOLUME /opt/haproxy

# ETCD configuration: server and prefix
ENV ETCD_NODE 172.17.42.1:4001
ENV ETCD_PREFIX haproxy-confd
# Stats port
ENV STATS_PORT 5000
# Log collector address:port
ENV LOG_HOST 127.0.0.1:514

ENV confd_ver 0.10.0

ENTRYPOINT ["/entrypoint.sh"]

RUN apk --update add haproxy wget openssl

RUN wget --progress=bar:force --retry-connrefused -t 5 --no-check-certificate https://github.com/kelseyhightower/confd/releases/download/v${confd_ver}/confd-${confd_ver}-linux-amd64 -O /bin/confd && chmod +x /bin/confd

# Image directories:
# - /usr/local/etc/confd: confd configuration generated by entrypoint script.
# - /usr/local/etc/haproxy: haproxy configuration generated by confd.
# - /home/haproxy: haproxy home dir for haproxy.pid file
# - /var/log/haproxy: lhaproxy log directory
# - /opt/haproxy: directory for SSL key, certificate and pem file.

RUN mkdir -p /usr/local/etc/haproxy && \
    mkdir -p /usr/local/etc/confd && \
    mkdir -p /home/haproxy && \
    mkdir -p /var/log/haproxy && \
    mkdir -p /opt/haproxy && \
    chown -R haproxy:haproxy /usr/local/etc/haproxy && \
    chown -R haproxy:haproxy /usr/local/etc/confd && \
    chown -R haproxy:haproxy /home/haproxy && \
    chown -R haproxy:haproxy /var/log/haproxy && \
    chown -R haproxy:haproxy /opt/haproxy

ADD entrypoint.sh /entrypoint.sh
ADD confd /etc/confd

USER haproxy
WORKDIR /home/haproxy

# Service port
EXPOSE 8443
