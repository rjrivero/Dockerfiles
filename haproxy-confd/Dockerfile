FROM gliderlabs/alpine:latest

MAINTAINER rjrivero

VOLUME /etc/confd

# ETCD configuration: server and prefix
ENV ETCD_NODE 172.17.42.1:4001
ENV ETCD_PREFIX haproxy-confd

# Authentication credentials and port for stats binding
# Deprecated, use the /users key in the service definition
#ENV STATS_USER admin
#ENV STATS_PASSWORD Changeme!
ENV STATS_PORT 5000

# Log collector address:port
ENV LOG_HOST 127.0.0.1

ENV confd_ver 0.10.0

ENTRYPOINT ["/entrypoint.sh"]

RUN apk --update add haproxy wget

RUN wget --progress=bar:force --retry-connrefused -t 5 --no-check-certificate https://github.com/kelseyhightower/confd/releases/download/v${confd_ver}/confd-${confd_ver}-linux-amd64 -O /bin/confd && chmod +x /bin/confd

# Image directories:
# - /usr/local/etc/confd: confd configuration generated by entrypoint script.
# - /usr/local/etc/haproxy: haproxy configuration generated by confd.
# - /home/haproxy: haproxy home dir for haproxy.pid file
# - /var/log/haproxy: lhaproxy log directory

RUN mkdir -p /usr/local/etc/haproxy && \
    mkdir -p /usr/local/etc/confd && \
    mkdir -p /home/haproxy && \
    mkdir -p /var/log/haproxy && \
    chown -R haproxy:haproxy /usr/local/etc/haproxy && \
    chown -R haproxy:haproxy /usr/local/etc/confd && \
    chown -R haproxy:haproxy /home/haproxy && \
    chown -R haproxy:haproxy /var/log/haproxy

ADD entrypoint.sh /entrypoint.sh
ADD confd /etc/confd

USER haproxy
WORKDIR /home/haproxy

# Service port
EXPOSE 8080
